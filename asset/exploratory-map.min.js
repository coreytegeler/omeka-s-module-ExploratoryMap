!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("ExploratoryMap",[],t):"object"==typeof exports?exports.ExploratoryMap=t():e.ExploratoryMap=t()}(window,(function(){return function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){r(2);class s{constructor(e={}){this.options=Object.assign({selector:".exploratory-map-block",color:"#0dae0b"},e),this.markers=[],this.bounds=[],this.sources={},this.layers={},this.overlays={},this.block=document.querySelector(this.options.selector),this.block||console.warn('No element matched the selector "'+this.options.selector+'"'),this.container=this.block.querySelector(".map-container"),this.type=this.block.dataset.mapType;let{basemap:t,accessToken:r}=this.block.dataset;this.block.removeAttribute("data-basemap"),this.block.removeAttribute("data-access-token"),this.forms=this.block.querySelectorAll(".layer-form"),this.colors={},mapboxgl.accessToken=r,this.map=new mapboxgl.Map({container:this.container,zoom:3}),this.map.on("load",this.handleMapLoad.bind(this)),this.map.on("style.load",this.handleStyleLoad.bind(this)),this.map.setStyle(t);const s=this.block.querySelector(".sort-list");if(s){new List(s,{valueNames:["title","date","type"]}).sort("date",{order:"asc"})}}handleMapLoad(e){const t=this;this.map.on("mouseenter","markers",this.hoverMarker.bind(this)),this.map.on("mouseleave","markers",this.unhoverMarker.bind(this)),this.map.on("click","markers",this.clickMarker.bind(this)),this.map.on("click",this.clickMap.bind(this)),this.block.querySelectorAll(".item").forEach((function(e,r){e.addEventListener("mousedown",t.clickItem.bind(t))})),this.block.querySelectorAll(".layer-form input").forEach((function(e,r){e.addEventListener("click",t.changeLayer.bind(t))}))}handleStyleLoad(e){Object.keys(this.layers).length?Object.keys(this.layers).forEach(e=>{if(!this.map.getSource(e)){const t=this.layers[e],r=this.sources[e],s=document.getElementById(e);s&&s.checked&&(t.layout.visibility="visible"),this.map.addSource(e,r),this.map.addLayer(t)}}):(this.addOverlays(),this.addMarkers())}changeLayer(e){const t=e.currentTarget,r=t.checked,s=t.parentElement,a=t.id,i=s.dataset.layerType,o=t.value;if("basemap"==i&&r&&this.map.setStyle(o),"overlay"==i&&Object.keys(this.overlays).forEach(e=>{this.overlays[e];a==e&&r?this.map.setLayoutProperty(e,"visibility","visible"):(document.getElementById(e).checked=!1,this.map.setLayoutProperty(e,"visibility","none"))}),"markers"==i){const e=s.querySelectorAll("input:checked"),t=Array.from(e).map(e=>e.value);this.map.setFilter("markers",["in","type"].concat(t))}}addOverlays(){const e=this;this.block.querySelectorAll("input[name='overlay']").forEach((function(t,r){let s=t.id,a=t.value,i=t.checked;if(!e.map.getSource(s+"")&&a){const r={type:"raster",url:t.value},a={id:s,source:s,type:"raster",layout:{visibility:i?"visible":"none"}};e.map.addSource(s,r),e.map.addLayer(a),e.overlays[s]=a,e.layers[s]=a,e.sources[s]=r}}))}addMarkers(){const e=this,t=this.block.dataset.markers,r=t?JSON.parse(t):null;if(this.block.removeAttribute("data-markers"),!r)return!1;this.sources.markers={type:"geojson",data:{type:"FeatureCollection",features:[]}};let s=new mapboxgl.LngLatBounds;r.forEach((function(t,r){if(!t.lng||!t.lat)return;const a=[t.lng,t.lat];let i={type:"Feature",properties:{description:t.caption?t.caption:"",title:t.title?t.title:"",index:Number.isInteger(r)?r+1:"",item:t.item?t.item:"",type:t.type?t.type:""},geometry:{type:"Point",coordinates:a}};e.sources.markers.data.features.push(i),e.markers.push(i),e.getMarkerData(i,t),s.extend(a)})),this.sources["markers-labels"]=this.sources.markers,this.map.addSource("markers",this.sources.markers),this.map.addSource("markers-labels",this.sources["markers-labels"]);let a=this.options.color;"layered"==this.type&&(a=["match",["get","type"]],this.block.querySelectorAll(".layer-filter input").forEach((function(t,r){const s=t.getAttribute("id"),a=s?e.block.querySelector("[for='"+s+"']"):null,i=t?t.value:null,o=a?window.getComputedStyle(a).color:null;i&&i&&(e.colors[i]=o)})),Object.keys(this.colors).forEach(e=>{const t=this.colors[e];a.push(e),a.push(t)}),a.push(this.options.color));let i=["interpolate",["linear"],["zoom"],10,5,17,8];i=["match",["get","type"],"Landmarks",5,8];const o={id:"markers",type:"circle",source:"markers",paint:{"circle-color":a,"circle-radius":i,"circle-stroke-color":"rgba(255,255,255,.9)","circle-stroke-width":1.5}},n={id:"markers-labels",type:"symbol",source:"markers-labels",minzoom:13,paint:{"text-color":"#000000","text-halo-color":"rgba(255,255,255,.9)","text-halo-width":1.5},layout:{"text-field":"{title}","text-size":["match",["get","type"],"Landmarks",15,"",15,0],"text-font":["Open Sans Semibold","Arial Unicode MS Bold"],"text-offset":[0,.6],"text-anchor":"top"}};this.map.addLayer(o),this.map.addLayer(n),this.layers.markers=o,this.layers["markers-labels"]=n,this.map.fitBounds(s,{padding:{top:100,bottom:100,left:100,right:100},animate:!1}),this.bounds=s,this.block.classList.add("loaded")}resetMap(){this.closePanel(),this.map.fitBounds(this.bounds,{padding:{top:100,bottom:100,left:100,right:100},animate:!0})}flyTo(e){const t=this,r=this.block.querySelector(".item.current"),s=r?r.dataset.index:null;if(e&&parseInt(s)!==parseInt(e)){this.block.querySelector(".item[data-index='"+e+"']");let r=this.findItem(e),a=15,i=this.findPanel(e).offsetWidth+a,o=this.block.offsetWidth,n=o/2-(o-i)/2,l=r.dataset.lng,c=r.dataset.lat;if(r.classList.add("current"),l&&c){let r=[l,c];this.map.flyTo({center:r,speed:5,zoom:15}),this.map.once("moveend",(function(r){let a=t.map.getCenter();const i=t.map.project(a);i.x-=n,a=t.map.unproject(i),t.map.flyTo({center:a}),t.openPanel(e),s&&t.closePanel(s,!0)}))}}else{let e=this.block.querySelector(".item.hidden");e&&e.classList.add("current")}}clickArrow(e){if(!this.block.classList.contains("loaded"))return;let t,r=e.currentTarget.getAttribute("data-direction"),s=this.block.querySelectorAll(".item"),a=this.block.querySelector(".item.current");if(a?"next"===r?t=a.nextElementSibling:"prev"===r&&(t=a.previousElementSibling):t=s[0],t){let e=t.dataset.index;this.flyTo(e)}else this.resetMap()}clickItem(e){let t=e.currentTarget;if(this.block.classList.contains("loaded")&&t){let e=t.dataset.index;this.flyTo(e)}}getMarkerData(e,t){const r=this,s=t.item;$.ajax({type:"GET",dataType:"json",url:"/api/items/"+s,success:function(t){r.populatePanel(e,t)},error:function(e,t,r){console.log(e,t,r)}})}populatePanel(e,t){const r=document.createElement("div");r.classList.add("map-panel"),r.dataset.index=e.properties.index;const s=document.createElement("header"),a=document.createElement("h2");if(a.innerText=e.properties.title,s.appendChild(a),"story"===this.type){const e=document.createElement("div");e.classList.add("map-arrow"),e.dataset.direction="prev",e.addEventListener("mousedown",this.clickArrow.bind(this));const t=document.createElement("div");t.classList.add("map-arrow"),t.dataset.direction="next",t.addEventListener("mousedown",this.clickArrow.bind(this)),s.appendChild(e),s.appendChild(t)}let i=document.createElement("div");i.classList.add("panel-inner"),i.appendChild(a.cloneNode(!0));let o=document.createElement("div");o.classList.add("panel-scroll");let n=document.createElement("div");n.classList.add("panel-properties"),r.appendChild(s),i.appendChild(n),o.appendChild(i),r.appendChild(o),this.container.appendChild(r);[["alternative","Alt Title"],["date","Date"],["description","Description"],["references","Referenced Items"],["mediator","Media"]].forEach((function(e,r){let s=e[0],a=e[1],i=t["dcterms:"+s];if(i){let e=document.createElement("div");e.classList.add("panel-property"),e.classList.add(s),document.createElement("div").innerText=a,i.forEach((function(t,r){if("resource:item"===t.type){const r=t.display_title,s=t["@id"].replace("api","home").replace("items","item");let a=document.createElement("a");if(a.href=s,a.target="_blank","Mediator"===t.property_label){const e=t.thumbnail_url,r=document.createElement("img");r.src=e,a.appendChild(r)}else a.innerText=r;e.appendChild(a)}else{let r=t["@value"];if("date"==s){const e=new Date(r),t=["January","February","March","April","May","June","July","August","September","October","November","December"],s=e.getUTCMonth(),a=e.getUTCDate(),i=e.getUTCFullYear();e.toString("dddd, MMMM ,yyyy");r=`${t[s]} ${a}, ${i}`}e.innerText+=r}})),e&&n.appendChild(e)}})),i.appendChild(n)}hoverMarker(e){this.map.getCanvas().style.cursor="pointer"}unhoverMarker(e){this.map.getCanvas().style.cursor=""}clickMarker(e){let t=e.features[0].properties.index;this.flyTo(t)}clickMap(e){const{lngLat:t}=e;console.log("Coordinates:",t.lat+", "+t.lng)}openPanel(e){const t=this,r=this.findPanel(e);this.findPanel()&&r.classList.add("swap"),r.classList.add("show"),setTimeout((function(){r.classList.remove("swap"),t.map.once("click",(function(s){t.closePanel(e),r.classList.remove("show")}))}))}closePanel(e,t){let r=this.findPanel(e);r&&(t&&r.classList.add("swap"),r.classList.remove("show"),setTimeout((function(){r.classList.remove("swap")})));let s=this.findItem(e);s&&s.classList.remove("current")}findPanel(e){let t;return e&&(t=this.container.querySelector(".map-panel[data-index='"+e+"']")),t||(t=this.container.querySelector(".map-panel.show"),t||!1)}findItem(e){let t=this.block.querySelector(".item[data-index='"+e+"']");return t||(t=this.block.querySelector(".item.current"),t||!1)}findMarker(e,t){}}window.onload=function(){new s({})}},function(e,t,r){}])}));